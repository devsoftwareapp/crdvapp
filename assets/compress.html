<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compress PDF</title>
  <script src="pdf-lib.min.js"></script>
  <script src="pdf.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #d32f2f;
      text-align: center;
      margin-bottom: 10px;
    }
    .description {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }
    .box {
      background: #f8f9fa;
      border-left: 4px solid #d32f2f;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover {
      background: #b71c1c;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .progress {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #d32f2f;
      border-radius: 10px;
      transition: width 0.3s;
    }
    .size-compare {
      margin-top: 10px;
      font-size: 15px;
    }
    .size-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .savings {
      color: #28a745;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Compress PDF</h1>
    <p class="description" id="description">Reduce PDF file size</p>

    <div class="box">
      <h3 id="selectPdfFile">Select PDF File</h3>
      <input type="file" id="compressFile" accept="application/pdf">
    </div>

    <div class="box">
      <h3 id="compressionSettings">Compression Settings</h3>
      <label for="quality" id="imageQuality">Image Quality:</label>
      <select id="quality">
        <option value="0.7" id="highQuality">High (larger size)</option>
        <option value="0.5" id="mediumQuality" selected>Medium (balanced quality)</option>
        <option value="0.3" id="lowQuality">Low (smallest size)</option>
      </select>
      <button id="compressBtn">Compress and Save PDF</button>
    </div>

    <div class="box">
      <h3 id="compressionStatus">Compression Status</h3>
      <div id="compressStatusText" class="status info">No operation performed yet.</div>
      <div class="progress" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <div id="sizeCompare" class="size-compare" style="display: none;"></div>
    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    let localeData = {};

    async function loadLocale() {
      try {
        const res = await fetch("compress-all.json");
        const allLocales = await res.json();
        const userLang = (navigator.language || "en-us").toLowerCase();
        localeData = allLocales[userLang] || allLocales["en-us"];
        applyLocale();
      } catch (e) {
        console.warn("Locale file not loaded, using defaults.");
      }
    }

    function applyLocale() {
      for (const [key, value] of Object.entries(localeData)) {
        const el = document.getElementById(key);
        if (el) el.textContent = value;
      }
      document.getElementById("compressBtn").textContent = localeData.compressBtn || "Compress and Save PDF";
    }

    function formatBytes(bytes) {
      if (bytes === 0) return "0 B";
      const k = 1024;
      const sizes = ["B", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function updateProgress(percent) {
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percent + '%';
    }

    function showStatus(message, type) {
      const status = document.getElementById('compressStatusText');
      status.textContent = message;
      status.className = `status ${type}`;
    }

    async function compressPDF(file, quality) {
      const compare = document.getElementById('sizeCompare');
      const progress = document.querySelector('.progress');
      const originalSize = file.size;

      compare.innerHTML = `
        <div class="size-item">
          <span>${localeData.originalSize || "üì¶ Original size:"}</span>
          <span><b>${formatBytes(originalSize)}</b></span>
        </div>
      `;
      compare.style.display = 'block';
      progress.style.display = 'block';

      showStatus(localeData.readingPdf || 'üìñ Reading PDF...', 'info');
      updateProgress(10);

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const pdfDoc = await PDFLib.PDFDocument.create();
      const totalPages = pdf.numPages;

      showStatus((localeData.processingPages || "üñºÔ∏è Processing {pages} pages...").replace("{pages}", totalPages), 'info');
      updateProgress(20);

      for (let i = 1; i <= totalPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1.2 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: ctx, viewport }).promise;

        const imgData = canvas.toDataURL("image/jpeg", parseFloat(quality));
        const jpgBytes = await fetch(imgData).then(res => res.arrayBuffer());
        const jpgImage = await pdfDoc.embedJpg(jpgBytes);

        const pdfPage = pdfDoc.addPage([viewport.width, viewport.height]);
        pdfPage.drawImage(jpgImage, { x: 0, y: 0, width: viewport.width, height: viewport.height });

        const progressPercent = 20 + (i / totalPages) * 70;
        updateProgress(progressPercent);
        showStatus((localeData.processingPage || "üß© Page {current}/{total} processed...")
          .replace("{current}", i)
          .replace("{total}", totalPages), 'info');
      }

      const compressedBytes = await pdfDoc.save();
      const blob = new Blob([compressedBytes], { type: "application/pdf" });
      const compressedSize = blob.size;

      const diff = 100 - ((compressedSize / originalSize) * 100);
      const saved = (diff > 0 ? diff.toFixed(1) : 0);

      compare.innerHTML += `
        <div class="size-item">
          <span>${localeData.newSize || "üìâ New size:"}</span>
          <span><b>${formatBytes(compressedSize)}</b></span>
        </div>
        <div class="size-item savings">
          <span>${localeData.savings || "üíæ Savings:"}</span>
          <span><b>${saved}%</b></span>
        </div>
      `;

      updateProgress(100);

      if (window.flutter_inappwebview) {
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64 = reader.result.split(',')[1];
          const fileName = "compressed_" + file.name;
          window.flutter_inappwebview.callHandler('saveFile', fileName, base64);
        };
        reader.readAsDataURL(blob);
      }

      showStatus(localeData.compressedSaved || "‚úÖ Compressed PDF saved!", 'success');
      return blob;
    }

    document.getElementById("compressBtn").addEventListener("click", async () => {
      const file = document.getElementById("compressFile").files[0];
      const quality = document.getElementById("quality").value;

      if (!file) {
        showStatus(localeData.pleaseSelectPdf || "Please select a PDF file!", "error");
        return;
      }

      try {
        await compressPDF(file, quality);
      } catch (e) {
        console.error(e);
        showStatus((localeData.errorPrefix || "‚ùå Error:") + " " + e.message, "error");
      }
    });

    if (window.flutter_inappwebview) {
      window.flutter_inappwebview.registerHandler('saveFile', function(data, callback) {
        console.log('File saved:', data);
      });
    }

    loadLocale();
  </script>
</body>
</html>
